---
- name: Test user_setup role with coverage
  hosts: all
  become: true
  gather_facts: false

  vars:
    ansible_user_dir: "/root"
    user_setup_shells:
      - bash
      - zsh
    user_setup_custom_aliases:
      ll: "ls -l"
      gs: "git status"
    user_setup_environment_variables:
      EDITOR: nano
      LANG: en_US.UTF-8
    git_email: "test@example.com"
    git_name: "Test User"

  pre_tasks:
    - name: Install Python and other required packages
      ansible.builtin.raw: |
        set -e
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          python3 python3-pip python3-apt sudo bash zsh
        ln -sf /usr/bin/python3 /usr/bin/python
      register: install_result
      changed_when: install_result.rc == 0
      ignore_errors: true
      retries: 3
      delay: 5
      until: install_result is succeeded

    - name: Ensure remote temporary directory exists
      ansible.builtin.file:
        path: /tmp/ansible
        state: directory
        mode: '1777'
        owner: root
        group: root

  tasks:
    - name: Gather facts after Python is installed
      ansible.builtin.setup:
      when: not ansible_facts

    - name: Apply user_setup role with full coverage
      ansible.builtin.include_role:
        name: user_setup

    - name: Verify role execution
      ansible.builtin.debug:
        msg: "user_setup role executed successfully for bash and zsh with aliases and env vars"
